<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freelance Income Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root{--bg:#f3f4f6;--card:#ffffff;--muted:#6b7280;--accent:#3b82f6;--danger:#ef4444;--radius:12px;--gap:12px;--pad:16px}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;padding:18px;background:var(--bg);color:#0f172a}
    .wrap{max-width:880px;margin:0 auto;display:flex;gap:var(--gap);flex-direction:column;align-items:stretch}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 30px rgba(2,6,23,0.06);padding:var(--pad);overflow:hidden}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:8px}
    h1{margin:0;font-size:20px}
    form {display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px}
    .row .field{flex:1}
    input[type="text"], input[type="date"], input[type="number"], textarea {width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:transparent}
    textarea{min-height:52px;resize:vertical}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(59,130,246,0.12)}
    .mini{font-size:13px;color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid #eef2f7;background:#fff}
    .item .left{display:flex;flex-direction:column}
    .item .meta{font-size:13px;color:var(--muted)}
    .remove{background:transparent;border:none;color:var(--danger);font-size:18px;cursor:pointer}
    @media (max-width:700px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div id="root" class="wrap"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo } = React;
  const STORAGE_KEY = 'freelance_income_tracker_singlefile_v4';

  function uid(){ return Math.random().toString(36).slice(2,9); }
  function formatDateISO(d){ const dt = new Date(d); return dt.toISOString().slice(0,10); }
  function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
  function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
  function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), daysInMonth(date.getFullYear(), date.getMonth())); }
  function sumAmounts(record){ return Number(record.amount||0); }

  function App(){
    const [payments, setPayments] = useState(()=>{
      try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return []; const parsed = JSON.parse(raw); return parsed.payments || parsed || []; }catch(e){ return []; }
    });

    const [form, setForm] = useState({ date: formatDateISO(new Date()), amount: '', note: '', payer: '' });

    useEffect(()=>{
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({ payments })); }catch(e){}
    },[payments]);

    function addPayment(e){ e && e.preventDefault();
      const date = form.date || formatDateISO(new Date());
      const rec = { id: uid(), date, amount: Number(form.amount||0), note: form.note || '', payer: form.payer || '' };
      setPayments(p => [...p, rec].sort((a,b)=>a.date.localeCompare(b.date)));
      setForm({ date: formatDateISO(new Date()), amount:'', note:'', payer:'' });
    }

    function removePayment(id){
      setPayments(p => p.filter(x => x.id !== id));
    }

    const today = new Date();
    const monthStart = startOfMonth(today);
    const monthEnd = endOfMonth(today);

    const paymentsThisMonth = useMemo(()=> payments.filter(p=>{
      const d = new Date(p.date + 'T00:00:00');
      return d >= monthStart && d <= monthEnd;
    }), [payments]);

    const totalRecordedInMonth = useMemo(()=> paymentsThisMonth.reduce((a,r)=>a + sumAmounts(r), 0), [paymentsThisMonth]);

    const totalDaysInMonth = daysInMonth(today.getFullYear(), today.getMonth());
    const avgPerDay = totalDaysInMonth ? totalRecordedInMonth / totalDaysInMonth : 0;
    const projection = avgPerDay * totalDaysInMonth;

    return (
      <div>
        <div className="card" style={{marginBottom:12}}>
          <header>
            <h1>Freelance Income Tracker</h1>
            <div style={{fontSize:13,color:'#6b7280'}}>Данные сохраняются в браузере</div>
          </header>

          <form onSubmit={addPayment}>
            <div className="row">
              <div className="field"><input type="date" value={form.date} onChange={e=>setForm({...form, date: e.target.value})} /></div>
              <div className="field"><input type="text" placeholder="Кто внёс (имя)" value={form.payer} onChange={e=>setForm({...form, payer: e.target.value})} /></div>
            </div>
            <div style={{marginTop:6}}><input type="number" placeholder="Сумма" value={form.amount} onChange={e=>setForm({...form, amount: e.target.value})} /></div>
            <div style={{marginTop:6}}><textarea placeholder="Комментарий" value={form.note} onChange={e=>setForm({...form, note: e.target.value})}></textarea></div>
            <div style={{display:'flex',gap:8,marginTop:8}}>
              <button className="btn">Добавить</button>
              <button type="button" className="btn secondary" onClick={()=>{ setPayments([]); localStorage.removeItem(STORAGE_KEY); }}>Очистить всё</button>
            </div>
          </form>
        </div>

        <div style={{display:'flex',gap:12,flexWrap:'wrap',marginBottom:12}}>
          <div className="card" style={{flex:1,minWidth:220}}>
            <div className="mini">Учтено в этом месяце (по дату {formatDateISO(today)})</div>
            <div style={{fontSize:18,fontWeight:600,marginTop:6}}>{totalRecordedInMonth.toFixed(2)} ₽</div>
          </div>

          <div className="card" style={{flex:1,minWidth:260}}>
            <div className="mini">Прогноз на месяц (по среднему за день, учтено все платежи)</div>
            <div style={{marginTop:8,fontSize:16}}>Среднее в день: <strong>{avgPerDay.toFixed(2)} ₽</strong></div>
            <div style={{marginTop:8,fontWeight:600}}>Проекция на месяц: {projection.toFixed(2)} ₽</div>
          </div>
        </div>

        <div className="card">
          <h3 style={{marginTop:0}}>Платежи (этот месяц)</h3>
          <div className="list" style={{marginTop:8}}>
            {paymentsThisMonth.length === 0 ? <div className="mini" style={{padding:10}}>Нет платежей в этом месяце</div> : paymentsThisMonth.map(p=>(
              <div key={p.id} className="item">
                <div className="left">
                  <div style={{fontWeight:600}}>{p.date} — {sumAmounts(p).toFixed(2)} ₽ {p.payer ? `— ${p.payer}` : ''}</div>
                  {p.note && <div className="meta">{p.note}</div>}
                </div>
                <div>
                  <button className="remove" onClick={()=>removePayment(p.id)} title="Удалить">✕</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
